include $(TOPDIR)/rules.mk

PKG_NAME:=iptest
PKG_VERSION:=1.2        # éšä¾¿å¡«ä¸ªç‰ˆæœ¬å·
PKG_RELEASE:=1

include $(INCLUDE_DIR)/package.mk
include $(TOPDIR)/feeds/packages/lang/golang/golang-package.mk

define Package/iptest
  SECTION:=net
  CATEGORY:=Network
  TITLE:=iptest - IP Test Tool
  # å¦‚æœæœ‰ä¾èµ–ï¼ˆå¦‚éœ€è¦ libc æˆ–å…¶ä»–åŒ…ï¼‰ï¼Œåœ¨è¿™é‡ŒåŠ ï¼Œä¾‹å¦‚ DEPENDS:= +libpthread
endef

define Package/iptest/description
  A simple IP testing tool written in Go.
endef

# æ¨¡å—åå¿…é¡»å’Œ go.mod é‡Œçš„ module xxx ä¸€è‡´
GO_PKG:=iptest

# å¦‚æœä½ çš„ç¨‹åºæœ‰å¤šä¸ª binary æˆ–ç‰¹æ®Šç¼–è¯‘ flagsï¼Œå¯ä»¥åœ¨è¿™é‡ŒåŠ 
# GO_PKG_BUILD_FLAGS:= -tags netgo

define Build/Compile
	$(call GoPackage/Build/Compile)
endef

$(eval $(call GoPackage,iptest))
$(eval $(call BuildPackage,iptest))          echo "CONFIG_TARGET_\( {TARGET}_ \){SUBTARGET}=y" >> .config
          
          # é’ˆå¯¹ RAX3000M çš„ç‰¹å®šè®¾å¤‡é…ç½®ï¼ˆmediatek/filogicï¼‰
          if [ "${{ matrix.platform }}" = "mediatek/filogic" ]; then
            echo "CONFIG_TARGET_DEVICE_mediatek_filogic_DEVICE_cmcc_rax3000m=y" >> .config
          fi
          
          # å¯ç”¨åŒæ ¼å¼æ”¯æŒå¹¶é€‰ä¸­è‡ªå®šä¹‰åŒ…
          echo "CONFIG_PACKAGE_APK=y" >> .config
          echo "CONFIG_PACKAGE_IPKG=y" >> .config
          echo "CONFIG_PACKAGE_iptest=m" >> .config
          if [ -d "package/custom/luci-app-iptest" ]; then
            echo "CONFIG_PACKAGE_luci-app-iptest=m" >> .config
          fi
          
          make defconfig
          
          # å‡†å¤‡å®¿ä¸»æœºå·¥å…·å’Œå·¥å…·é“¾
          echo ">> æ­£åœ¨å‡†å¤‡å®¿ä¸»æœºå·¥å…·å’Œå·¥å…·é“¾..."
          make tools/install -j$(nproc) || make tools/install V=s
          make toolchain/install -j$(nproc) || make toolchain/install V=s
          
          # Go ç¼–è¯‘ç¯å¢ƒä¼˜åŒ–
          # ç°åœ¨å·²æœ‰ go.modï¼Œæ­£å¸¸ä½¿ç”¨æ¨¡å—æ¨¡å¼
          # å¦‚æœ iptest æ˜¯çº¯ Goï¼ˆæ—  CGO ä¾èµ–ï¼‰ï¼Œè®¾ä¸º 0 å¯é¿å…äº¤å‰ç¼–è¯‘é—®é¢˜
          # å¦‚æœæœ‰ CGO ä¾èµ–ï¼Œå¯æ”¹ä¸º export CGO_ENABLED=1
          export CGO_ENABLED=0
          
          # ç¼–è¯‘ iptest æ ¸å¿ƒç¨‹åº
          echo ">> æ­£åœ¨ç¼–è¯‘ iptest æ ¸å¿ƒç¨‹åº..."
          make package/custom/iptest/compile V=s -j$(nproc) || make package/custom/iptest/compile V=s
          
          # ç¼–è¯‘ LuCI ç•Œé¢ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -d "package/custom/luci-app-iptest" ]; then
            echo ">> æ­£åœ¨ç¼–è¯‘ luci-app-iptest..."
            make package/custom/luci-app-iptest/compile V=s -j$(nproc) || make package/custom/luci-app-iptest/compile V=s
          fi

      - name: Organize Files
        run: |
          mkdir -p publish
          echo ">> æœé›†ç¼–è¯‘äº§ç‰©ï¼ˆiptest ç›¸å…³ ipk/apkï¼‰..."
          find source/bin/ -type f \( -name "*.ipk" -o -name "*.apk" \) | grep -i "iptest" | xargs -I {} cp {} publish/
          echo ">> æœé›†æ‰€æœ‰äº§ç‰©ï¼ˆå®Œæ•´åˆ—è¡¨ï¼‰..."
          find source/bin/ -type f \( -name "*.ipk" -o -name "*.apk" \) -exec cp {} publish/ \;

      - name: Check Results
        run: |
          echo "ğŸ“¦ æœ€ç»ˆäº§ç‰©æ¸…å•:"
          ls -lh publish/
          if [ -z "$(ls -A publish)" ]; then
            echo "âŒ é”™è¯¯: æœªå‘ç°ä»»ä½•ç¼–è¯‘äº§ç‰©!"
            exit 1
          fi
          echo "âœ… ç¼–è¯‘äº§ç‰©å·²æ”¶é›†åˆ° publish/ ç›®å½•"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iptest-${{ matrix.platform == 'x86/64' && 'x86_64' || (matrix.platform == 'rockchip/armv8' && 'rockchip_armv8' || (matrix.platform == 'mediatek/filogic' && 'filogic' || 'mt7621')) }}
          path: publish/          
          # å‡†å¤‡å®¿ä¸»æœºå·¥å…·å’Œå·¥å…·é“¾
          echo ">> æ­£åœ¨å‡†å¤‡å®¿ä¸»æœºå·¥å…·å’Œå·¥å…·é“¾..."
          make tools/install -j$(nproc) || make tools/install V=s
          make toolchain/install -j$(nproc) || make toolchain/install V=s
          
          # Go ç¼–è¯‘ç¯å¢ƒä¼˜åŒ–
          # ç°åœ¨å·²æœ‰ go.modï¼Œæ­£å¸¸ä½¿ç”¨æ¨¡å—æ¨¡å¼
          # å¦‚æœ iptest æ˜¯çº¯ Goï¼ˆæ—  CGO ä¾èµ–ï¼‰ï¼Œè®¾ä¸º 0 å¯é¿å…äº¤å‰ç¼–è¯‘é—®é¢˜
          # å¦‚æœæœ‰ CGO ä¾èµ–ï¼Œå¯æ”¹ä¸º export CGO_ENABLED=1
          export CGO_ENABLED=0
          
          # ç¼–è¯‘ iptest æ ¸å¿ƒç¨‹åº
          echo ">> æ­£åœ¨ç¼–è¯‘ iptest æ ¸å¿ƒç¨‹åº..."
          make package/custom/iptest/compile V=s -j$(nproc) || make package/custom/iptest/compile V=s
          
          # ç¼–è¯‘ LuCI ç•Œé¢ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -d "package/custom/luci-app-iptest" ]; then
            echo ">> æ­£åœ¨ç¼–è¯‘ luci-app-iptest..."
            make package/custom/luci-app-iptest/compile V=s -j$(nproc) || make package/custom/luci-app-iptest/compile V=s
          fi

      - name: Organize Files
        run: |
          mkdir -p publish
          echo ">> æœé›†ç¼–è¯‘äº§ç‰©ï¼ˆiptest ç›¸å…³ ipk/apkï¼‰..."
          find source/bin/ -type f \( -name "*.ipk" -o -name "*.apk" \) | grep -i "iptest" | xargs -I {} cp {} publish/
          echo ">> æœé›†æ‰€æœ‰äº§ç‰©ï¼ˆå®Œæ•´åˆ—è¡¨ï¼‰..."
          find source/bin/ -type f \( -name "*.ipk" -o -name "*.apk" \) -exec cp {} publish/ \;

      - name: Check Results
        run: |
          echo "ğŸ“¦ æœ€ç»ˆäº§ç‰©æ¸…å•:"
          ls -lh publish/
          if [ -z "$(ls -A publish)" ]; then
            echo "âŒ é”™è¯¯: æœªå‘ç°ä»»ä½•ç¼–è¯‘äº§ç‰©!"
            exit 1
          fi
          echo "âœ… ç¼–è¯‘äº§ç‰©å·²æ”¶é›†åˆ° publish/ ç›®å½•"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iptest-${{ matrix.platform == 'x86/64' && 'x86_64' || (matrix.platform == 'rockchip/armv8' && 'rockchip_armv8' || (matrix.platform == 'mediatek/filogic' && 'filogic' || 'mt7621')) }}
          path: publish/          
          # ç¼–è¯‘å®¿ä¸»æœºå·¥å…·å’Œå·¥å…·é“¾
          echo ">> æ­£åœ¨å‡†å¤‡å®¿ä¸»æœºå·¥å…·å’Œå·¥å…·é“¾..."
          make tools/install -j$(nproc)
          make toolchain/install -j$(nproc)
          
          # ã€æ ¸å¿ƒä¿®å¤ã€‘å¼ºåˆ¶ç¦ç”¨ CGO ä»¥è§£å†³æœ¬åœ°åŠ MIPS æ¶æ„çš„ç¼–è¯‘æŠ¥é”™
          export CGO_ENABLED=0
          
          echo ">> æ­£åœ¨ç¼–è¯‘æ ¸å¿ƒç¨‹åº..."
          make package/custom/iptest/compile V=s -j$(nproc)
          
          echo ">> æ­£åœ¨ç¼–è¯‘ç•Œé¢ç¨‹åº..."
          make package/custom/luci-app-iptest/compile V=s -j$(nproc)

      - name: Organize Files
        run: |
          mkdir -p publish
          echo ">> æœé›†ç¼–è¯‘äº§ç‰©..."
          # ä½¿ç”¨æ›´å¹¿çš„æœç´¢èŒƒå›´
          find source/bin/ -type f \( -name "*.ipk" -o -name "*.apk" \) -name "*iptest*" -exec cp {} publish/ \;

      - name: Check Results
        run: |
          echo "ğŸ“¦ æœ€ç»ˆäº§ç‰©æ¸…å•:"
          ls -lh publish/
          if [ -z "$(ls -A publish)" ]; then
            echo "âŒ é”™è¯¯: æœªå‘ç°ç¼–è¯‘äº§ç‰©!"
            exit 1
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iptest-${{ matrix.platform == 'x86/64' && 'x86_64' || (matrix.platform == 'rockchip/armv8' && 'rockchip_armv8' || (matrix.platform == 'mediatek/filogic' && 'filogic' || 'mt7621')) }}
          path: publish/
