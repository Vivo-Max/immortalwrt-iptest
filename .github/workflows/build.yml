name: Build All Platforms

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    name: Build for ${{ matrix.platform }}
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        # å¹¶è¡Œç¼–è¯‘ 4 ç§æ¶æ„
        platform: ["x86/64", "rockchip/armv8", "mediatek/filogic", "ramips/mt7621"]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Initialization Environment
        run: |
          sudo apt update
          # å®‰è£…å®Œæ•´ç¼–è¯‘æ‰€éœ€çš„ Python åº“å’ŒåŸºç¡€å·¥å…·
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses-dev libssl-dev python3-setuptools python3-dev python3-pyelftools \
          rsync unzip zlib1g-dev file wget subversion swig

      - name: Clone ImmortalWrt
        run: |
          git clone -b master --depth 1 https://github.com/immortalwrt/immortalwrt.git source
          cd source
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Setup Custom Package
        run: |
          # åˆ›å»ºç›®æ ‡ç›®å½•ç»“æ„
          mkdir -p source/package/custom/iptest/src
          
          # å¤åˆ¶ Makefile åˆ°åŒ…æ ¹ç›®å½•
          if [ -f "iptest/Makefile" ]; then
            cp "iptest/Makefile" source/package/custom/iptest/Makefile
          else
            echo "é”™è¯¯: iptest/Makefile ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          
          # å¤åˆ¶æºç åˆ° src ç›®å½•ï¼ˆç°åœ¨ä»“åº“ä¸­ iptest/ ç›´æ¥åŒ…å« go.modã€go.sumã€iptest.goï¼‰
          if [ -d "iptest" ]; then
            cp -r iptest/* source/package/custom/iptest/src/
            # é˜²æ­¢è¯¯å¤åˆ¶ Makefile åˆ° srcï¼ˆåº”è¯¥åªåœ¨åŒ…æ ¹ï¼‰
            rm -f source/package/custom/iptest/src/Makefile
          else
            echo "é”™è¯¯: iptest ç›®å½•ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          
          # å¤åˆ¶ LuCI ç•Œé¢éƒ¨åˆ†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -d "luci-app-iptest" ]; then
            cp -r luci-app-iptest source/package/custom/
          fi
          
          # éªŒè¯æ–‡ä»¶ç»“æ„
          echo "=== package/custom/iptest ç›®å½•ç»“æ„ ==="
          ls -R source/package/custom/iptest/
          echo "=== src ç›®å½•å†…å®¹ ==="
          ls -la source/package/custom/iptest/src/

      - name: Compile Packages
        run: |
          cd source
          
          # è§£æå¹³å°
          TARGET=$(echo ${{ matrix.platform }} | cut -d'/' -f1 | tr '/' '_')
          SUBTARGET=$(echo ${{ matrix.platform }} | cut -d'/' -f2)
          
          # åŸºæœ¬é…ç½®
          echo "CONFIG_TARGET_${TARGET}=y" > .config
          echo "CONFIG_TARGET_\( {TARGET}_ \){SUBTARGET}=y" >> .config
          
          # é’ˆå¯¹ RAX3000M çš„ç‰¹å®šè®¾å¤‡é…ç½®ï¼ˆmediatek/filogicï¼‰
          if [ "${{ matrix.platform }}" = "mediatek/filogic" ]; then
            echo "CONFIG_TARGET_DEVICE_mediatek_filogic_DEVICE_cmcc_rax3000m=y" >> .config
          fi
          
          # å¯ç”¨åŒæ ¼å¼æ”¯æŒå¹¶é€‰ä¸­è‡ªå®šä¹‰åŒ…
          echo "CONFIG_PACKAGE_APK=y" >> .config
          echo "CONFIG_PACKAGE_IPKG=y" >> .config
          echo "CONFIG_PACKAGE_iptest=m" >> .config
          if [ -d "package/custom/luci-app-iptest" ]; then
            echo "CONFIG_PACKAGE_luci-app-iptest=m" >> .config
          fi
          
          make defconfig
          
          # å‡†å¤‡å®¿ä¸»æœºå·¥å…·å’Œå·¥å…·é“¾
          echo ">> æ­£åœ¨å‡†å¤‡å®¿ä¸»æœºå·¥å…·å’Œå·¥å…·é“¾..."
          make tools/install -j$(nproc) || make tools/install V=s
          make toolchain/install -j$(nproc) || make toolchain/install V=s
          
          # Go ç¼–è¯‘ç¯å¢ƒä¼˜åŒ–
          # ç°åœ¨å·²æœ‰ go.modï¼Œæ­£å¸¸ä½¿ç”¨æ¨¡å—æ¨¡å¼
          # å¦‚æœ iptest æ˜¯çº¯ Goï¼ˆæ—  CGO ä¾èµ–ï¼‰ï¼Œè®¾ä¸º 0 å¯é¿å…äº¤å‰ç¼–è¯‘é—®é¢˜
          # å¦‚æœæœ‰ CGO ä¾èµ–ï¼Œå¯æ”¹ä¸º export CGO_ENABLED=1
          export CGO_ENABLED=0
          
          # ç¼–è¯‘ iptest æ ¸å¿ƒç¨‹åº
          echo ">> æ­£åœ¨ç¼–è¯‘ iptest æ ¸å¿ƒç¨‹åº..."
          make package/custom/iptest/compile V=s -j$(nproc) || make package/custom/iptest/compile V=s
          
          # ç¼–è¯‘ LuCI ç•Œé¢ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -d "package/custom/luci-app-iptest" ]; then
            echo ">> æ­£åœ¨ç¼–è¯‘ luci-app-iptest..."
            make package/custom/luci-app-iptest/compile V=s -j$(nproc) || make package/custom/luci-app-iptest/compile V=s
          fi

      - name: Organize Files
        run: |
          mkdir -p publish
          echo ">> æœé›†ç¼–è¯‘äº§ç‰©ï¼ˆiptest ç›¸å…³ ipk/apkï¼‰..."
          find source/bin/ -type f \( -name "*.ipk" -o -name "*.apk" \) | grep -i "iptest" | xargs -I {} cp {} publish/
          echo ">> æœé›†æ‰€æœ‰äº§ç‰©ï¼ˆå®Œæ•´åˆ—è¡¨ï¼‰..."
          find source/bin/ -type f \( -name "*.ipk" -o -name "*.apk" \) -exec cp {} publish/ \;

      - name: Check Results
        run: |
          echo "ğŸ“¦ æœ€ç»ˆäº§ç‰©æ¸…å•:"
          ls -lh publish/
          if [ -z "$(ls -A publish)" ]; then
            echo "âŒ é”™è¯¯: æœªå‘ç°ä»»ä½•ç¼–è¯‘äº§ç‰©!"
            exit 1
          fi
          echo "âœ… ç¼–è¯‘äº§ç‰©å·²æ”¶é›†åˆ° publish/ ç›®å½•"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iptest-${{ matrix.platform == 'x86/64' && 'x86_64' || (matrix.platform == 'rockchip/armv8' && 'rockchip_armv8' || (matrix.platform == 'mediatek/filogic' && 'filogic' || 'mt7621')) }}
          path: publish/          
          # å‡†å¤‡å®¿ä¸»æœºå·¥å…·å’Œå·¥å…·é“¾
          echo ">> æ­£åœ¨å‡†å¤‡å®¿ä¸»æœºå·¥å…·å’Œå·¥å…·é“¾..."
          make tools/install -j$(nproc) || make tools/install V=s
          make toolchain/install -j$(nproc) || make toolchain/install V=s
          
          # Go ç¼–è¯‘ç¯å¢ƒä¼˜åŒ–
          # ç°åœ¨å·²æœ‰ go.modï¼Œæ­£å¸¸ä½¿ç”¨æ¨¡å—æ¨¡å¼
          # å¦‚æœ iptest æ˜¯çº¯ Goï¼ˆæ—  CGO ä¾èµ–ï¼‰ï¼Œè®¾ä¸º 0 å¯é¿å…äº¤å‰ç¼–è¯‘é—®é¢˜
          # å¦‚æœæœ‰ CGO ä¾èµ–ï¼Œå¯æ”¹ä¸º export CGO_ENABLED=1
          export CGO_ENABLED=0
          
          # ç¼–è¯‘ iptest æ ¸å¿ƒç¨‹åº
          echo ">> æ­£åœ¨ç¼–è¯‘ iptest æ ¸å¿ƒç¨‹åº..."
          make package/custom/iptest/compile V=s -j$(nproc) || make package/custom/iptest/compile V=s
          
          # ç¼–è¯‘ LuCI ç•Œé¢ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -d "package/custom/luci-app-iptest" ]; then
            echo ">> æ­£åœ¨ç¼–è¯‘ luci-app-iptest..."
            make package/custom/luci-app-iptest/compile V=s -j$(nproc) || make package/custom/luci-app-iptest/compile V=s
          fi

      - name: Organize Files
        run: |
          mkdir -p publish
          echo ">> æœé›†ç¼–è¯‘äº§ç‰©ï¼ˆiptest ç›¸å…³ ipk/apkï¼‰..."
          find source/bin/ -type f \( -name "*.ipk" -o -name "*.apk" \) | grep -i "iptest" | xargs -I {} cp {} publish/
          echo ">> æœé›†æ‰€æœ‰äº§ç‰©ï¼ˆå®Œæ•´åˆ—è¡¨ï¼‰..."
          find source/bin/ -type f \( -name "*.ipk" -o -name "*.apk" \) -exec cp {} publish/ \;

      - name: Check Results
        run: |
          echo "ğŸ“¦ æœ€ç»ˆäº§ç‰©æ¸…å•:"
          ls -lh publish/
          if [ -z "$(ls -A publish)" ]; then
            echo "âŒ é”™è¯¯: æœªå‘ç°ä»»ä½•ç¼–è¯‘äº§ç‰©!"
            exit 1
          fi
          echo "âœ… ç¼–è¯‘äº§ç‰©å·²æ”¶é›†åˆ° publish/ ç›®å½•"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iptest-${{ matrix.platform == 'x86/64' && 'x86_64' || (matrix.platform == 'rockchip/armv8' && 'rockchip_armv8' || (matrix.platform == 'mediatek/filogic' && 'filogic' || 'mt7621')) }}
          path: publish/          
          # ç¼–è¯‘å®¿ä¸»æœºå·¥å…·å’Œå·¥å…·é“¾
          echo ">> æ­£åœ¨å‡†å¤‡å®¿ä¸»æœºå·¥å…·å’Œå·¥å…·é“¾..."
          make tools/install -j$(nproc)
          make toolchain/install -j$(nproc)
          
          # ã€æ ¸å¿ƒä¿®å¤ã€‘å¼ºåˆ¶ç¦ç”¨ CGO ä»¥è§£å†³æœ¬åœ°åŠ MIPS æ¶æ„çš„ç¼–è¯‘æŠ¥é”™
          export CGO_ENABLED=0
          
          echo ">> æ­£åœ¨ç¼–è¯‘æ ¸å¿ƒç¨‹åº..."
          make package/custom/iptest/compile V=s -j$(nproc)
          
          echo ">> æ­£åœ¨ç¼–è¯‘ç•Œé¢ç¨‹åº..."
          make package/custom/luci-app-iptest/compile V=s -j$(nproc)

      - name: Organize Files
        run: |
          mkdir -p publish
          echo ">> æœé›†ç¼–è¯‘äº§ç‰©..."
          # ä½¿ç”¨æ›´å¹¿çš„æœç´¢èŒƒå›´
          find source/bin/ -type f \( -name "*.ipk" -o -name "*.apk" \) -name "*iptest*" -exec cp {} publish/ \;

      - name: Check Results
        run: |
          echo "ğŸ“¦ æœ€ç»ˆäº§ç‰©æ¸…å•:"
          ls -lh publish/
          if [ -z "$(ls -A publish)" ]; then
            echo "âŒ é”™è¯¯: æœªå‘ç°ç¼–è¯‘äº§ç‰©!"
            exit 1
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iptest-${{ matrix.platform == 'x86/64' && 'x86_64' || (matrix.platform == 'rockchip/armv8' && 'rockchip_armv8' || (matrix.platform == 'mediatek/filogic' && 'filogic' || 'mt7621')) }}
          path: publish/
