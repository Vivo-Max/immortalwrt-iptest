name: Build All Platforms

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    name: Build for ${{ matrix.platform }}
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        # å¹¶è¡Œç¼–è¯‘ 4 ç§æ¶æ„
        platform: ["x86/64", "rockchip/armv8", "mediatek/filogic", "ramips/mt7621"]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Initialization Environment
        run: |
          sudo apt update
          # å®‰è£…å®Œæ•´ç¼–è¯‘æ‰€éœ€çš„ Python åº“å’ŒåŸºç¡€å·¥å…·
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses-dev libssl-dev python3-setuptools python3-dev python3-pyelftools \
          rsync unzip zlib1g-dev file wget subversion swig

      - name: Clone ImmortalWrt
        run: |
          git clone -b master --depth 1 https://github.com/immortalwrt/immortalwrt.git source
          cd source
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Setup Custom Package
        run: |
          # 1. åˆ›å»ºç›®æ ‡ç›®å½•ç»“æ„
          mkdir -p source/package/custom/iptest/src
          
          # 2. å¥å£®å¤åˆ¶é€»è¾‘ï¼šç›´æ¥å¤åˆ¶ç›®å½•å†…å®¹è€Œéä½¿ç”¨å¤æ‚çš„ find
          # å¤åˆ¶ Makefile åˆ°åŒ…æ ¹ç›®å½•
          if [ -f "iptest/Makefile" ]; then
            cp iptest/Makefile source/package/custom/iptest/Makefile
          fi
          
          # å¤åˆ¶æ‰€æœ‰æºç åˆ° src ç›®å½•ï¼Œç¡®ä¿é’ˆå¯¹ Makefile ä¸­çš„ ./src/* è·¯å¾„
          # ä½¿ç”¨ -r ç¡®ä¿å³ä½¿æœ‰å­ç›®å½•ä¹Ÿèƒ½å®Œæ•´ä¿ç•™
          if [ -d "iptest" ]; then
            cp -r iptest/. source/package/custom/iptest/src/
            # æ¸…ç† src ç›®å½•ä¸‹è¯¯å…¥çš„ Makefileï¼ˆMakefile åº”è¯¥åœ¨ä¸Šä¸€çº§ï¼‰
            rm -f source/package/custom/iptest/src/Makefile
          fi
          
          # 3. å¤åˆ¶ LuCI ç•Œé¢éƒ¨åˆ†
          if [ -d "luci-app-iptest" ]; then
            cp -r luci-app-iptest source/package/custom/
          fi
          
          # éªŒè¯æ–‡ä»¶ç»“æ„ (è°ƒè¯•ç”¨)
          echo "æ£€æŸ¥æ–‡ä»¶å­˜æ”¾ç»“æœ:"
          ls -R source/package/custom/iptest/

      - name: Compile Packages
        run: |
          cd source
          TARGET=$(echo ${{ matrix.platform }} | cut -d'/' -f1)
          SUBTARGET=$(echo ${{ matrix.platform }} | cut -d'/' -f2)
          
          # å†™å…¥é…ç½®
          echo "CONFIG_TARGET_${TARGET}=y" > .config
          echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" >> .config
          
          # é’ˆå¯¹ RAX3000M çš„ç‰¹å®šé…ç½®
          if [ "$SUBTARGET" == "filogic" ]; then
            echo "CONFIG_TARGET_DEVICE_mediatek_filogic_DEVICE_cmcc_rax3000m=y" >> .config
          fi
          
          # å¼€å¯åŒæ ¼å¼æ”¯æŒå¹¶é€‰ä¸­æ’ä»¶
          echo "CONFIG_PACKAGE_APK=y" >> .config
          echo "CONFIG_PACKAGE_IPKG=y" >> .config
          echo "CONFIG_PACKAGE_iptest=m" >> .config
          echo "CONFIG_PACKAGE_luci-app-iptest=m" >> .config
          
          make defconfig
          
          # ç¼–è¯‘å®¿ä¸»æœºå·¥å…·å’Œå·¥å…·é“¾
          echo ">> æ­£åœ¨å‡†å¤‡å®¿ä¸»æœºå·¥å…·å’Œå·¥å…·é“¾..."
          make tools/install -j$(nproc)
          make toolchain/install -j$(nproc)
          
          # ã€æ ¸å¿ƒä¿®å¤ã€‘å¼ºåˆ¶ç¦ç”¨ CGO ä»¥è§£å†³æœ¬åœ°åŠ MIPS æ¶æ„çš„ç¼–è¯‘æŠ¥é”™
          export CGO_ENABLED=0
          
          echo ">> æ­£åœ¨ç¼–è¯‘æ ¸å¿ƒç¨‹åº..."
          make package/custom/iptest/compile V=s -j$(nproc)
          
          echo ">> æ­£åœ¨ç¼–è¯‘ç•Œé¢ç¨‹åº..."
          make package/custom/luci-app-iptest/compile V=s -j$(nproc)

      - name: Organize Files
        run: |
          mkdir -p publish
          echo ">> æœé›†ç¼–è¯‘äº§ç‰©..."
          # ä½¿ç”¨æ›´å¹¿çš„æœç´¢èŒƒå›´
          find source/bin/ -type f \( -name "*.ipk" -o -name "*.apk" \) -name "*iptest*" -exec cp {} publish/ \;

      - name: Check Results
        run: |
          echo "ğŸ“¦ æœ€ç»ˆäº§ç‰©æ¸…å•:"
          ls -lh publish/
          if [ -z "$(ls -A publish)" ]; then
            echo "âŒ é”™è¯¯: æœªå‘ç°ç¼–è¯‘äº§ç‰©!"
            exit 1
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iptest-${{ matrix.platform == 'x86/64' && 'x86_64' || (matrix.platform == 'rockchip/armv8' && 'rockchip_armv8' || (matrix.platform == 'mediatek/filogic' && 'filogic' || 'mt7621')) }}
          path: publish/
