- name: Compile Packages
  run: |
    cd source
    export GOPROXY=https://goproxy.cn,direct
    export GOSUMDB=sum.golang.google.cn

    PLATFORM="${{ matrix.platform }}"
    TARGET=${PLATFORM%/*}
    SUBTARGET=${PLATFORM#*/}

    BUILD_DIR="build-${TARGET}_${SUBTARGET}"
    mkdir -p "$BUILD_DIR"
    rsync -a --delete ./ "$BUILD_DIR/"
    cd "$BUILD_DIR"

    # 自动生成 .config
    cat << EOF > .config
CONFIG_TARGET_$TARGET=y
CONFIG_TARGET_${TARGET}_$SUBTARGET=y
CONFIG_PACKAGE_iptest=m
CONFIG_PACKAGE_luci-app-iptest=m
EOF
    [ "$SUBTARGET" = "filogic" ] && echo "CONFIG_TARGET_DEVICE_mediatek_filogic_DEVICE_cmcc_rax3000m=y" >> .config

    # 分别编译 APK 和 IPK
    for FMT in "apk" "ipk"; do
      sed -i '/^CONFIG_PACKAGE_APK/d' .config
      sed -i '/^CONFIG_PACKAGE_IPKG/d' .config
      [ "$FMT" = "apk" ] && echo "CONFIG_PACKAGE_APK=y" >> .config || echo "CONFIG_PACKAGE_IPKG=y" >> .config
      yes "" | make defconfig

      make tools/install -j$(nproc) || make tools/install V=s
      make toolchain/install -j$(nproc) || make toolchain/install V=s
      make package/custom/iptest/compile V=s -j$(nproc) || make package/custom/iptest/compile V=s
      make package/custom/luci-app-iptest/compile V=s -j$(nproc) || true
    done
